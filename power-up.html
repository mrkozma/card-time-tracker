<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Card Time Tracker Power-Up</title>
    <script src="https://p.trellocdn.com/power-up.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
            line-height: 1.5;
        }
    </style>
</head>
<body>
    <script>
        // ===== CONFIGURATION =====
        const CONFIG = {
            CUSTOM_FIELDS: {
                CREATION_DATE: 'Creation Date',
                COMPLETION_DATE: 'Completion Date'
            },
            AGE_THRESHOLD: 7 // Days - 7+ days = red badge
        };

        // ===== UTILITY FUNCTIONS =====

        /**
         * Parse ISO date string to Date object
         * Handles both formats: "YYYY-MM-DD" and "YYYY-MM-DDTHH:mm:ss.sssZ"
         */
        function parseISODate(dateStr) {
            if (!dateStr) return null;

            // If it's already a full ISO timestamp, use it directly
            if (dateStr.includes('T')) {
                const date = new Date(dateStr);
                return isNaN(date.getTime()) ? null : date;
            }

            // If it's just a date string (YYYY-MM-DD), add time
            const date = new Date(dateStr + 'T00:00:00Z');
            return isNaN(date.getTime()) ? null : date;
        }

        /**
         * Get today's date in ISO format
         */
        function getTodayISO() {
            const d = new Date();
            const year = d.getFullYear();
            const month = String(d.getMonth() + 1).padStart(2, '0');
            const day = String(d.getDate()).padStart(2, '0');
            return `${year}-${month}-${day}`;
        }

        /**
         * Calculate calendar days between two dates (ISO strings)
         * Uses calendar days (midnight to midnight), not elapsed time
         * Example: Oct 22 4PM to Oct 24 1AM = 2 days (crosses 2 calendar days)
         */
        function calculateCalendarDays(startDateStr, endDateStr) {
            const start = parseISODate(startDateStr);
            const end = parseISODate(endDateStr);

            if (!start || !end) return 0;

            // Normalize both dates to midnight UTC for calendar day calculation
            const startMidnight = new Date(Date.UTC(start.getUTCFullYear(), start.getUTCMonth(), start.getUTCDate()));
            const endMidnight = new Date(Date.UTC(end.getUTCFullYear(), end.getUTCMonth(), end.getUTCDate()));

            console.log('Calendar day calculation:', {
                startDate: startMidnight.toISOString(),
                endDate: endMidnight.toISOString()
            });

            const oneDay = 24 * 60 * 60 * 1000;
            const diffTime = Math.abs(endMidnight - startMidnight);
            const days = Math.floor(diffTime / oneDay);

            console.log('Diff time (ms):', diffTime, 'Days:', days);

            return days;
        }

        /**
         * Get badge color based on card age
         * Green: < 7 days, Red: >= 7 days
         */
        function getBadgeColor(cardAge) {
            return cardAge < CONFIG.AGE_THRESHOLD ? 'green' : 'red';
        }

        /**
         * Get all custom fields on the board
         */
        async function getBoardCustomFields(t) {
            try {
                const board = await t.board('customFields');
                const fields = board?.customFields || [];
                console.log('Custom fields retrieved:', fields);
                return Array.isArray(fields) ? fields : [];
            } catch (error) {
                console.error('Error getting custom fields:', error);
                return [];
            }
        }

        /**
         * Get custom field value for a card (from within badge callback context)
         * Note: In badge callback, t.card() is context-aware and doesn't need cardId
         */
        async function getCardCustomFieldValue(t, fieldId) {
            try {
                if (!fieldId) {
                    console.log('No fieldId provided');
                    return null;
                }

                // In badge callback context, t.card() already knows which card we're on
                const card = await t.card('customFieldItems');
                console.log('Card customFieldItems:', card);

                const items = card?.customFieldItems || [];
                console.log('Custom field items array:', items);

                if (Array.isArray(items) && items.length > 0) {
                    const item = items.find(item => item.idCustomField === fieldId);
                    console.log('Found item for fieldId', fieldId, ':', item);
                    console.log('Item value object:', item?.value);
                    console.log('Item value keys:', item?.value ? Object.keys(item.value) : 'no value object');

                    // Try different value formats
                    const value = item?.value?.text || item?.value?.date || null;
                    console.log('Extracted value:', value);
                    return value;
                }

                console.log('No custom field items found');
                return null;
            } catch (error) {
                console.error('Error getting custom field value:', error);
                return null;
            }
        }

        /**
         * Get custom field value for a specific card (from analytics modal context)
         * Note: Outside of badge callback, we need to pass the cardId
         */
        async function getCardCustomFieldValueById(t, cardId, fieldId) {
            try {
                if (!fieldId) {
                    return null;
                }

                const card = await t.card(cardId, 'customFieldItems');
                const items = card?.customFieldItems || [];

                if (Array.isArray(items) && items.length > 0) {
                    const item = items.find(item => item.idCustomField === fieldId);
                    // Try different value formats (text for text fields, date for date fields)
                    const value = item?.value?.text || item?.value?.date || null;
                    return value;
                }

                return null;
            } catch (error) {
                console.error('Error getting custom field value by ID:', error);
                return null;
            }
        }

        // ===== CARD BADGES CALLBACK =====

        function cardBadgesCallback(t, opts) {
            return [{
                dynamic: async function() {
                    try {
                        console.log('=== Badge Callback Started ===');

                        // Get card ID
                        const cardIdObj = await t.card('id');
                        const cardId = cardIdObj.id;
                        console.log('Card ID:', cardId);

                        if (!cardId) {
                            console.log('No card ID found');
                            return null;
                        }

                        // Get custom field IDs
                        console.log('Fetching custom fields from board...');
                        const customFields = await getBoardCustomFields(t);

                        const creationDateField = customFields.find(f => f.name === CONFIG.CUSTOM_FIELDS.CREATION_DATE);
                        const completionDateField = customFields.find(f => f.name === CONFIG.CUSTOM_FIELDS.COMPLETION_DATE);

                        console.log('Creation Date Field:', creationDateField);
                        console.log('Completion Date Field:', completionDateField);

                        if (!creationDateField) {
                            console.log('Creation Date custom field not found on board');
                            return null;
                        }

                        // Get custom field values
                        const creationDateStr = await getCardCustomFieldValue(t, creationDateField.id);
                        const completionDateStr = await getCardCustomFieldValue(t, completionDateField?.id);

                        console.log('Creation Date:', creationDateStr);
                        console.log('Completion Date:', completionDateStr);

                        if (!creationDateStr) {
                            console.log('Card has no creation date set');
                            return null;
                        }

                        // Calculate card age
                        // If completion date exists, use it; otherwise use today
                        const ageEndDate = completionDateStr || getTodayISO();
                        const cardAge = calculateCalendarDays(creationDateStr, ageEndDate);

                        console.log('Card age calculation:', {
                            creationDateStr,
                            ageEndDate,
                            cardAge
                        });

                        // Determine badge color based on completion status and card age
                        // If completed, use blue; otherwise use age-based color (green/red)
                        let badgeColor;
                        if (completionDateStr) {
                            // Card is completed - use blue background
                            badgeColor = 'blue';
                        } else {
                            // Card is active - use age-based color
                            badgeColor = getBadgeColor(cardAge);
                        }

                        // Format badge text - just show card age
                        const badgeText = `⏱️ ${cardAge}d`;

                        console.log('Badge ready:', badgeText, 'color:', badgeColor, 'isCompleted:', !!completionDateStr);

                        return {
                            text: badgeText,
                            color: badgeColor
                        };

                    } catch (error) {
                        console.error('Error in dynamic badge:', error);
                        return null;
                    }
                },
                // Minimum refresh is 10 seconds (Trello requirement)
                refresh: 10
            }];
        }

        // ===== CARD BUTTONS CALLBACK =====

        function cardButtonsCallback(t, options) {
            const card = options.context.card;

            if (!card || !card.id) {
                return [];
            }

            return [{
                text: 'Time Analytics',
                icon: 'https://cdn-icons-png.flaticon.com/512/2838/2838912.png',
                callback: function(t) {
                    openAnalyticsModal(t, card.id);
                }
            }];
        }

        // ===== ANALYTICS MODAL =====

        async function openAnalyticsModal(t, cardId) {
            try {
                // Get card name
                const cardData = await t.card(cardId, 'name');
                const cardName = cardData?.name || 'Unknown Card';

                // Get custom field IDs
                const customFields = await getBoardCustomFields(t);
                const creationDateField = customFields.find(f => f.name === CONFIG.CUSTOM_FIELDS.CREATION_DATE);
                const completionDateField = customFields.find(f => f.name === CONFIG.CUSTOM_FIELDS.COMPLETION_DATE);

                if (!creationDateField) {
                    alert('Creation Date custom field not set up. Please create it in board settings.');
                    return;
                }

                // Get custom field values
                const creationDateStr = await getCardCustomFieldValueById(t, cardId, creationDateField.id);
                const completionDateStr = await getCardCustomFieldValueById(t, cardId, completionDateField?.id);

                if (!creationDateStr) {
                    alert('Card has no creation date set. Please set the Creation Date custom field.');
                    return;
                }

                // Calculate card age
                const ageEndDate = completionDateStr || getTodayISO();
                const cardAge = calculateCalendarDays(creationDateStr, ageEndDate);

                // Prepare modal data
                const modalData = {
                    cardId: cardId,
                    cardName: cardName,
                    cardAge: cardAge,
                    creationDate: creationDateStr,
                    completionDate: completionDateStr || 'Not set',
                    isCompleted: !!completionDateStr
                };

                // Open modal with data
                const params = new URLSearchParams(modalData).toString();
                const modalUrl = `https://mrkozma.github.io/card-time-tracker/time-modal.html?${params}`;

                t.showPopup({
                    title: 'Time Analytics - ' + cardName,
                    url: modalUrl,
                    height: 500
                });

            } catch (error) {
                console.error('Error opening analytics modal:', error);
                alert('Error: Could not open analytics modal. Check console for details.');
            }
        }

        // ===== INITIALIZE POWER-UP =====
        TrelloPowerUp.initialize({
            'card-badges': cardBadgesCallback,
            'card-buttons': cardButtonsCallback
        });

    </script>
</body>
</html>
